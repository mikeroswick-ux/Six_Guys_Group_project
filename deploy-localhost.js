// éƒ¨ç½²åˆ° localhost ç½‘ç»œï¼ˆç‹¬ç«‹ Hardhat èŠ‚ç‚¹ï¼‰
const { ethers } = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
	console.log("\nðŸš€ Deploying to localhost network...\n");
	
	// æ£€æŸ¥æ˜¯å¦è¿žæŽ¥åˆ° localhost
	try {
		const provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545");
		const blockNumber = await provider.getBlockNumber();
		console.log(`âœ… Connected to localhost (Block: ${blockNumber})\n`);
	} catch (error) {
		console.error("âŒ Cannot connect to localhost node");
		console.log("\nðŸ’¡ è¯·å…ˆå¯åŠ¨ Hardhat èŠ‚ç‚¹:");
		console.log("   npx hardhat node\n");
		process.exit(1);
	}

	const [deployer] = await ethers.getSigners();
	console.log("ðŸ‘¤ Deployer:", deployer.address);

	const supply = ethers.parseUnits("1000000", 18);
	const TestToken = await ethers.getContractFactory("TestToken");
	const tokenA = await TestToken.deploy("TokenA", "TKA", supply);
	const tokenB = await TestToken.deploy("TokenB", "TKB", supply);
	await tokenA.waitForDeployment();
	await tokenB.waitForDeployment();
	
	const tokenAAddress = await tokenA.getAddress();
	const tokenBAddress = await tokenB.getAddress();
	console.log("âœ… TokenA:", tokenAAddress);
	console.log("âœ… TokenB:", tokenBAddress);

	const DEX = await ethers.getContractFactory("DEX");
	const dex = await DEX.deploy(tokenAAddress, tokenBAddress);
	await dex.waitForDeployment();
	
	const dexAddress = await dex.getAddress();
	console.log("âœ… DEX:", dexAddress);
	
	// èŽ·å–LP Tokenåœ°å€
	const lpTokenAddress = await dex.lpToken();
	console.log("âœ… LPToken:", lpTokenAddress);

	// approve initial liquidity from deployer
	await (await tokenA.approve(dexAddress, ethers.MaxUint256)).wait();
	await (await tokenB.approve(dexAddress, ethers.MaxUint256)).wait();

	// add initial liquidity 10_000 each
	await (await dex.addLiquidity(ethers.parseUnits("10000", 18), ethers.parseUnits("10000", 18))).wait();
	console.log("\nâœ… Initial liquidity added");

	// ç”Ÿæˆ .env æ–‡ä»¶
	const envContent = `# DEX Contract Addresses (Auto-generated by deploy script)
# Generated at: ${new Date().toISOString()}
# Network: localhost (ç‹¬ç«‹ Hardhat èŠ‚ç‚¹)

# DEX Contract
DEX_ADDRESS=${dexAddress}

# Token Contracts
TOKEN0_ADDRESS=${tokenAAddress}
TOKEN1_ADDRESS=${tokenBAddress}

# LP Token Contract
LP_TOKEN_ADDRESS=${lpTokenAddress}

# Server Configuration
PORT=3001
RPC_URL=http://127.0.0.1:8545

# Network Configuration
CHAIN_ID=31337
CORS_ORIGIN=*
`;

	const envPath = path.join(__dirname, "..", ".env");
	fs.writeFileSync(envPath, envContent);
	console.log("\nâœ… .env file generated successfully!");
	console.log("ðŸ“ File location:", envPath);
	
	// åŒæ—¶è¾“å‡ºåˆ°æŽ§åˆ¶å°ï¼Œæ–¹ä¾¿å¤åˆ¶
	console.log("\n" + "=".repeat(60));
	console.log("Contract Addresses Summary:");
	console.log("=".repeat(60));
	console.log(`DEX_ADDRESS=${dexAddress}`);
	console.log(`TOKEN0_ADDRESS=${tokenAAddress}`);
	console.log(`TOKEN1_ADDRESS=${tokenBAddress}`);
	console.log(`LP_TOKEN_ADDRESS=${lpTokenAddress}`);
	console.log("=".repeat(60));
	console.log("\nðŸ’¡ ä¸‹ä¸€æ­¥:");
	console.log("   1. é‡å¯åŽç«¯æœåŠ¡å™¨: npm run server");
	console.log("   2. åˆ·æ–°å‰ç«¯é¡µé¢");
}

main().catch((e) => {
	console.error(e);
	process.exit(1);
});

